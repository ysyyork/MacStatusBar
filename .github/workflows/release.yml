name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0

permissions:
  contents: write  # Required to create releases

jobs:
  build:
    runs-on: macos-14  # Use macOS 14 (Sonoma) with Xcode 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Build app
        run: |
          xcodebuild -scheme MacStatusBar \
            -configuration Release \
            -derivedDataPath build \
            -destination 'generic/platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Prepare app for distribution
        run: |
          # Find the built app
          APP_PATH=$(find build -name "MacStatusBar.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          # Copy to a clean location
          mkdir -p dist
          cp -R "$APP_PATH" dist/

          # Remove code signature (if any) to avoid issues
          codesign --remove-signature dist/MacStatusBar.app 2>/dev/null || true

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          # Build create-dmg command (without --volicon since app has no custom icon)
          create-dmg \
            --volname "MacStatusBar" \
            --window-pos 200 120 \
            --window-size 540 380 \
            --icon-size 128 \
            --icon "MacStatusBar.app" 140 170 \
            --app-drop-link 400 170 \
            --hide-extension "MacStatusBar.app" \
            --no-internet-enable \
            "MacStatusBar-${{ github.ref_name }}.dmg" \
            "dist/"

          # Remove any temporary rw.* DMG files created by create-dmg
          rm -f rw.*.dmg

          # Verify DMG was created
          ls -la *.dmg

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: MacStatusBar-DMG
          path: "MacStatusBar-${{ github.ref_name }}.dmg"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: "MacStatusBar-${{ github.ref_name }}.dmg"
          body: |
            ## MacStatusBar ${{ github.ref_name }}

            ### Installation
            1. Download the DMG file below
            2. Open the DMG and drag MacStatusBar to Applications
            3. **First launch**: Right-click the app → Open → Open (required for unsigned apps)

            ### Requirements
            - macOS 14.0 (Sonoma) or later

            ### What's New
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
